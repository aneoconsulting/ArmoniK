# **ArmoniK Authentication Configuration Guide**

This guide aims to present the setup of the authentication framework within ArmoniK.

## **What authentication means in ArmoniK**

Authentication in ArmoniK is about security. Without authentication, anyone with access to the gRPC endpoints can send requests to it, potentially running undesirable workloads. 

ArmoniK uses client certificates to authenticate users. Authentication allows users who have the right certificates to send requests to the different endpoints. Different certificates can grant different permissions, based on a User-Role-Permission system.

## **Authentication options in ArmoniK**
You can setup authentication in several ways when deploying ArmoniK :

- **No authentication** : Any user with access to the endpoints can send any request.
- **Ingress authentication** : Only users with valid client certificates can send any request to the endpoints. Client certificate authority and custom unique client certificate are generated.
- **Ingress authentication, custom CA** : Only users with valid client certificates can send any request to the endpoints. Client certificate authority must be provided at deployment.
- **Ingress + Control plane authentication** : Only users with valid client certificates can send requests to the endpoints. Two users are created by default, one with access to all endpoints and requests and one with access to only the monitoring endpoints and requests. These certificates are generated by the ArmoniK deployment (See [How to setup authentication using default certificates](#how-to-setup-authentication-using-default-certificates)).
- **Ingress + Control plane authentication, custom CA** : Only users with valid client certificates can send requests to the endpoints. Users, roles and permissions are setup manually. Certificates are not generated by the deployment, meaning the client certificate authority must be provided during deployment and user certificates are not automatically generated (See [How to setup your own certificates for authentication](#how-to-setup-your-own-certificates-for-authentication) for details).

## **Authentication options features table**
|               Authentication Option               | No client certificate | Method access restriction | Autogenerated Certificates | Custom roles | Custom certificates |
|:-------------------------------------------------:|:---------------------:|:-------------------------:|:--------------------------:|:------------:|:-------------------:|
|                 No authentication                 |          ✔️           |           ❌             |             ❌             |      ❌     |         ❌          |
|              Ingress authentication               |          ❌           |           ❌             |             ✔️             |      ❌     |         ❌          |
|         Ingress authentication, custom CA         |          ❌           |           ❌             |             ❌             |      ❌     |         ✔️          |
|      Ingress + Control plane authentication       |          ❌           |           ✔️             |             ✔️             |      ❌     |         ❌          |
| Ingress + Control plane authentication, custom CA |          ❌           |           ✔️             |             ❌             |      ✔️     |         ✔️          |

# **Deployment configuration**
For each of the following configuration, the required parameters in your ```parameters.tfvars``` to specify are:
- ingress.mTLS : Controls whether the ingress requires user certificates
- ingress.generate_client_cert : Controls whether the deployment generates the default certificates with different roles
- ingress.custom_client_ca_file : Empty if the ingress should use a generated self signed certificate authority, otherwise uses the certificate specified at the given path
- authentication.require_authentication : Controls whether the control plane requires user certificates in database
- authentication.require_authorization : Controls whether the control plane checks for user permissions
- authentication.authentication_datafile : Empty if the default generated certificates will be used, otherwise is a path to a json configuration file (See [How to create a Json authentication configuration file](#how-to-create-a-json-authentication-configuration-file))

## **How to setup a deployment without authentication**
| Configuration parameter                      |    Value    |
|:---------------------------------------------|:-----------:|
| ```ingress.mTLS```                           | ```false``` |
| ```ingress.generate_client_cert```           | ```false``` |
| ```ingress.custom_client_ca_file```          |  ```""```   |
| ```authentication.require_authentication```  | ```false``` |
| ```authentication.require_authorization```   | ```false``` |
| ```authentication.authentication_datafile``` |  ```""```   |

Using this configuration, anyone with access to the endpoints can send any request.

## **How to setup mTLS authentication using a default certificate authority and a single user certificate**
| Configuration parameter                      |    Value    |
|:---------------------------------------------|:-----------:|
| ```ingress.mTLS```                           | ```true``` |
| ```ingress.generate_client_cert```           | ```false``` |
| ```ingress.custom_client_ca_file```          |  ```""```   |
| ```authentication.require_authentication```  | ```true/false``` |
| ```authentication.require_authorization```   | ```false``` |
| ```authentication.authentication_datafile``` |  ```""```   |

Using this configuration, a default client certificate will be generated. Anyone can access the endpoints using this certificate. Since this certificate will be put in the database by default, the parameter ```authentication.require_authentication``` can be set to true or false. The default client certificate is located at ```infrastructure/quick-deploy/localhost/armonik/generated/certificates/ingress/client.submitter.crt```

## **How to setup mTLS authentication using a custom certificate authority**
| Configuration parameter                      |    Value    |
|:---------------------------------------------|:-----------:|
| ```ingress.mTLS```                           | ```true``` |
| ```ingress.generate_client_cert```           | ```false``` |
| ```ingress.custom_client_ca_file```          |  ```Path to client ca.pem```   |
| ```authentication.require_authentication```  | ```false``` |
| ```authentication.require_authorization```   | ```false``` |
| ```authentication.authentication_datafile``` |  ```""```   |

Using this configuration, the specified ```ca.pem``` will be used to authenticate user certificates. The client certificates are not generated by the deployment.

## **How to setup authentication using default certificates**
| Configuration parameter                      |    Value    |
|:---------------------------------------------|:-----------:|
| ```ingress.mTLS```                           | ```true``` |
| ```ingress.generate_client_cert```           | ```true``` |
| ```ingress.custom_client_ca_file```          |  ```""```   |
| ```authentication.require_authentication```  | ```true``` |
| ```authentication.require_authorization```   | ```true``` |
| ```authentication.authentication_datafile``` |  ```""```   |

Default certificates are generated alongside the automatically generated client certificate authority. In this case, two certificates are generated in the ```infrastructure/quick-deploy/localhost/armonik/generated/certificates/ingress``` folder : ```client.submitter.crt``` which corresponds to a user with all permissions, and ```client.monitoring.crt``` which corresponds to a user with only monitoring permissions. You can modify the default users and roles created by modifying the module file [armonik/authentication-roles-default.tf](https://github.com/aneoconsulting/ArmoniK/blob/main/infrastructure/modules/armonik/authentication-roles-default.tf).

## **How to setup your own certificates for authentication**
| Configuration parameter                      |    Value    |
|:---------------------------------------------|:-----------:|
| ```ingress.mTLS```                           | ```true``` |
| ```ingress.generate_client_cert```           | ```false``` |
| ```ingress.custom_client_ca_file```          |  ```Path to client ca.pem```   |
| ```authentication.require_authentication```  | ```true``` |
| ```authentication.require_authorization```   | ```true``` |
| ```authentication.authentication_datafile``` |  ```Path to json authentication configuration file```   |

Using this configuration, the specified ```ca.pem``` will be used to authenticate user certificates. The client certificates are not generated by the deployment. Each certificate is attributed to a specific user with specific roles. Each role has specific permissions, allowing or denying the user access to specific endpoints. Each certificate, user and role need to be described in the given json configuration file (See [How to create a Json authentication configuration file](#how-to-create-a-json-authentication-configuration-file)). 

### **How to create a Json authentication configuration file**