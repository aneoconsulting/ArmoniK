# Monitoring in Armonik

Monitoring your Armonik deployment is crucial for maintaining performance, reliability, and resource optimization. By keeping a close eye on the system, you can quickly identify issues, optimize performance, and ensure that your application runs smoothly. Proper monitoring helps in understanding system load, user behavior, and identifying potential bottlenecks or failures before they escalate into major problems.

---

## Metrics Exporter

### Importance of the Metrics Exporter
The **Metrics Exporter** plays a vital role in gathering and exposing aggregated metrics that reflect the health and performance of your Armonik deployment. Metrics are key indicators that allow you to:

- **Assess System Health**: Monitor the status of tasks, helping you detect problems in real-time.
- **Optimize Resource Usage**: Analyze task metrics to fine-tune resource allocation and workload distribution.
- **Enable Proactive Management**: With proper metrics, you can anticipate issues and act before they affect the end-users.

### Metrics Exporter Tuning
- **Metrics exporter**: Computes and exposes aggregated metrics based on predefined statuses.
- **Default Metric**: The primary metric is **queued**, which represents the total number of tasks that are in the states of **Submitted**, **Dispatched**, and **Processing**. This provides a snapshot of the system's workload.

- To gather specific metrics tailored to your needs, you can use the following environment variable in the Core configmap:

  ```bash
  MetricsExporter__Metrics
  ```

  This will allow you to specify which additional metrics you want to track, ensuring that you are collecting data that is most relevant to your monitoring goals.

- Additionally, the **cache validity** setting allows you to determine how long cached results of measurements are considered valid. Adjusting this can help you manage how quickly metrics are updated:

  ```bash
  MetricsExporter__CacheValidity
  ```
  
  The default cache validity is set to **5 seconds**, which balances responsiveness and system load.

---

### Task Statuses
Understanding the various task statuses is essential for effective monitoring. The following table outlines the task statuses available in Armonik:

| **Status**       | **Description**                                           |
|------------------|-----------------------------------------------------------|
| `Unspecified`    | Task is in an unknown state.                              |
| `Creating`       | Task is being created in the database.                   |
| `Submitted`      | Task has been submitted to the queue.                    |
| `Dispatched`     | Task has been dispatched to a worker.                    |
| `Completed`      | Task has been completed successfully.                     |
| `Error`          | Task is in an error state, indicating a failure.         |
| `Timeout`        | Task has exceeded its processing time limit.             |
| `Cancelling`     | Task is in the process of being cancelled.               |
| `Cancelled`      | Task was cancelled as per the request.                   |
| `Processing`     | Task is currently being processed.                        |
| `Processed`      | Task processing is successful, and results are available. |
| `Retried`        | Task has failed and is being retried.                    |
| `Pending`        | Task is waiting for dependencies before execution.       |
| `Paused`         | Task is paused and will not resume execution until indicated. |

By monitoring these statuses, you can gain insights into the performance and operational health of your tasks.

---

### Adding More Metrics
To enhance your monitoring capabilities, you may wish to add additional metrics. Hereâ€™s how to do it:

1. **Edit the ConfigMap**: Make sure you're working with a running deployment of Armonik. Begin editing the `core-configmap` with this command:

   ```bash
   $ kubectl -n armonik edit configmaps core-configmap 
   ```

   > **Note**: For cloud deployments, ensure that the `KUBECONFIG` variable is exported in your current terminal context to access your Kubernetes cluster.

2. **Update Metrics Configuration**: In the configuration, you can specify which metrics to export. Add your desired metrics under the `MetricsExporter__Metrics` key. For example:

   ```bash
   # Please edit the object below. Lines beginning with a '#' will be ignored,
   # and an empty file will abort the edit.
   #
   apiVersion: v1
   data:
     MetricsExporter__Metrics: "Retried, Completed" # <- Add this line
     .
   # Rest of the file ...
   ```

3. **Restart the Deployment**: After updating the configuration, restart the `metrics-exporter` deployment so that it picks up your changes:

   ```bash
   $ kubectl -n armonik rollout restart deployment metrics-exporter
   ```

4. **Verify in Grafana**: Finally, check Grafana to ensure that the new metrics are now visible and being reported correctly.

---

## Prometheus

### Importance of Prometheus
Prometheus is a powerful monitoring and alerting toolkit designed for reliability and scalability. By integrating Prometheus into your Armonik deployment, you can:

- **Collect Time-Series Data**: Gather metrics over time for better analysis and historical reference.
- **Perform Complex Queries**: Leverage Prometheus's querying capabilities to glean insights into your data and performance trends.

### General Guidelines
- Ensure that Prometheus is properly dimensioned to handle the expected workload. This includes CPU, memory, and disk requirements.
- Configure Prometheus with persistence settings so that data is retained even across restarts.
- Set appropriate retention policies to manage how long data is kept, balancing storage capacity and the need for historical insights.

### Suggested Configuration
For optimal performance, it's recommended to run two instances of Prometheus:

- **Dedicated HPA Instance**: This instance can be smaller and configured with a shorter data retention policy (on the order of hours) to handle the metrics specific to Horizontal Pod Autoscaling (HPA).

- **Monitoring Instance**: This should be a larger instance, with a data retention period of at least **1 week** to allow for comprehensive monitoring and analysis.

Incorporating a robust monitoring setup using both the Metrics Exporter and Prometheus ensures that your Armonik deployment remains resilient, efficient, and responsive to the needs of your users.
